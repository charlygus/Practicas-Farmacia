<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mis Pr√°cticas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .badge { @apply px-2 py-0.5 inline-flex text-[10px] leading-4 font-bold rounded-full border; }
        .status-pendiente { @apply bg-yellow-50 text-yellow-700 border-yellow-200; }
        .status-exito { @apply bg-green-100 text-green-800 border-green-300; }
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .tab-active { @apply border-teal-600 text-teal-700 border-b-4 font-black; }
        .tab-inactive { @apply text-gray-400 border-b-4 border-transparent font-medium; }
        
        /* Animaciones */
        .bounce-pill { animation: bounce 1.5s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-30px) scale(1.1); } }
        
        /* Ajustes Mobile */
        .modal-scroll { -webkit-overflow-scrolling: touch; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-gray-800 font-sans antialiased overflow-hidden">

    <div id="global-loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center transition-all duration-700">
        <div class="text-9xl bounce-pill mb-12">üíä</div>
        <h2 class="text-xl font-black text-teal-900 tracking-tighter uppercase">Actualizando Datos</h2>
        <p id="loader-msg" class="text-gray-400 mt-3 text-xs font-bold tracking-widest uppercase animate-pulse text-center px-6">Sincronizando con Colegio Oficial...</p>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-6">
        <header class="mb-6 flex flex-col items-center bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
            <h1 class="text-2xl font-black text-teal-700 tracking-tight">Mis Pr√°cticas</h1>
            <nav class="flex w-full justify-around mt-5 border-t border-gray-50 pt-4">
                <button onclick="switchTab('practicas')" id="btn-practicas" class="tab-active pb-2 px-2 text-sm uppercase tracking-tighter transition-all">Pr√°cticas</button>
                <button onclick="switchTab('ofertas')" id="btn-ofertas" class="tab-inactive pb-2 px-2 text-sm uppercase tracking-tighter transition-all">Bolsa Empleo</button>
            </nav>
        </header>

        <div id="view-practicas" class="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100">
            <div class="overflow-x-auto hide-scrollbar">
                <table class="min-w-full divide-y divide-gray-50 text-xs">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left font-black text-gray-400 uppercase tracking-widest">Farmacia</th>
                            <th class="px-4 py-3 text-left font-black text-gray-400 uppercase tracking-widest">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="lista-farmacias" class="divide-y divide-gray-50"></tbody>
                </table>
            </div>
        </div>

        <div id="view-ofertas" class="hidden grid grid-cols-1 gap-4"></div>
    </div>

    <div id="modal-oferta" class="fixed inset-0 bg-black/80 hidden items-end sm:items-center justify-center z-50 backdrop-blur-md">
        <div class="bg-white rounded-t-[40px] sm:rounded-[40px] max-w-2xl w-full h-[90vh] sm:h-auto sm:max-h-[85vh] overflow-hidden shadow-2xl flex flex-col animate-in slide-in-from-bottom duration-300">
            <div class="h-1.5 w-12 bg-gray-200 rounded-full mx-auto mt-4 mb-2 sm:hidden"></div>
            <div class="p-6 border-b border-gray-50 flex justify-between items-center bg-white">
                <h3 id="modal-titulo" class="text-lg font-black text-teal-800 truncate pr-4 uppercase tracking-tighter">Detalles</h3>
                <button onclick="closeModal()" class="bg-gray-100 text-gray-400 w-10 h-10 rounded-full flex items-center justify-center text-2xl font-light hover:bg-red-50 hover:text-red-500 transition-all">&times;</button>
            </div>
            <div id="modal-contenido" class="p-6 overflow-y-auto grow modal-scroll bg-white"></div>
            <div class="p-6 border-t border-gray-50 bg-gray-50 flex gap-3">
                <button onclick="closeModal()" class="w-full bg-white text-gray-400 py-4 rounded-2xl font-black uppercase text-xs tracking-widest border border-gray-200 shadow-sm">Cerrar</button>
                <button id="modal-copy-btn" class="w-full bg-teal-600 text-white py-4 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg active:scale-95 transition-all">Copiar Email</button>
            </div>
        </div>
    </div>

    <script>
        const apiUrl = 'https://script.google.com/macros/s/AKfycbz96ggVZhkjS_ZxeqG_wb4qci60OF47-pPLUw5K6J3BJj2aR5KPRDEemjNh9HksjQYJog/exec';
        let globalJobData = [];

        async function init() {
            const msg = document.getElementById('loader-msg');
            try {
                // 1. Cargar Pr√°cticas
                msg.innerText = "Sincronizando Excel...";
                const practicasRes = await fetch(`${apiUrl}?v=${Date.now()}`);
                const practicasData = await practicasRes.json();
                renderPracticas(practicasData);

                // 2. Cargar Listado de Ofertas
                msg.innerText = "Escaneando COF Alicante...";
                const jobsRes = await fetch(`${apiUrl}?action=getJobs&v=${Date.now()}`);
                const jobList = await jobsRes.json();

                // 3. Pre-carga masiva de detalles
                msg.innerText = `Procesando ${jobList.length} vacantes...`;
                const detailPromises = jobList.map(async (job) => {
                    const res = await fetch(`${apiUrl}?action=getJobDetails&url=${encodeURIComponent(job.link)}`);
                    const details = await res.json();
                    return { ...job, ...details };
                });

                globalJobData = await Promise.all(detailPromises);
                renderOfertas(globalJobData);

                // FINALIZADO
                document.getElementById('global-loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('global-loader').classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }, 500);

            } catch (e) {
                msg.innerText = "Error en la conexi√≥n.";
                msg.className = "text-red-500 font-bold mt-4";
            }
        }

        function renderPracticas(data) {
            const tbody = document.getElementById('lista-farmacias');
            tbody.innerHTML = '';
            data.filter(row => row.FARMACIA).forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-4"><div class="font-black text-gray-800 text-sm">${row.FARMACIA}</div><div class="text-[9px] text-teal-600 font-mono font-bold uppercase tracking-tighter">${row.LOCALIDAD || ''}</div></td>
                    <td class="px-4 py-4"><span class="badge ${row.ESTADO?.includes('Acept') ? 'status-exito' : 'status-pendiente'}">${row.ESTADO || 'PENDIENTE'}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderOfertas(data) {
            const container = document.getElementById('view-ofertas');
            container.innerHTML = '';
            data.forEach((o, index) => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-[32px] shadow-sm border border-gray-100 flex justify-between items-center active:bg-gray-50 transition-all border-l-[10px] border-l-teal-500";
                card.onclick = () => openModal(index);
                card.innerHTML = `
                    <div class="pr-4">
                        <div class="text-[9px] font-black text-teal-600 mb-1 uppercase tracking-widest">${o.fecha}</div>
                        <h4 class="font-black text-gray-900 text-base leading-tight">${o.puesto}</h4>
                        <div class="text-gray-400 text-[10px] font-bold uppercase mt-1 tracking-tighter">${o.localidad}</div>
                    </div>
                    <div class="text-gray-300 text-2xl font-light">‚Üí</div>
                `;
                container.appendChild(card);
            });
        }

        function openModal(index) {
            const d = globalJobData[index];
            const content = document.getElementById('modal-contenido');
            document.getElementById('modal-copy-btn').onclick = () => {
                navigator.clipboard.writeText(d.email);
                alert('Email copiado');
            };
            
            content.innerHTML = `
                <div class="space-y-8 pb-10">
                    <div class="bg-teal-50 p-6 rounded-[35px] border border-teal-100">
                        <p class="text-[10px] font-black text-teal-600 uppercase mb-3 tracking-widest font-mono">Requisitos</p>
                        <p class="text-xl font-black text-gray-900 leading-[1.2] italic">
                            "${d.requisitos}"
                        </p>
                    </div>

                    <div class="space-y-4 px-2">
                        <div class="flex justify-between items-center border-b border-gray-50 pb-3">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Contacto</span>
                            <span class="text-sm font-medium text-gray-600">${d.persona}</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-gray-50 pb-3">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Tel√©fono</span>
                            <span class="text-sm font-medium text-gray-600">${d.telefono}</span>
                        </div>
                        <div class="flex flex-col border-b border-gray-50 pb-3">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Email</span>
                            <span class="text-sm font-medium text-gray-600 break-all">${d.email}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 px-2">
                        <div class="col-span-2">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Direcci√≥n</p>
                            <p class="text-xs font-bold text-gray-700">${d.direccion}</p>
                            <p class="text-[10px] text-gray-400">${d.localidad} (${d.cp})</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-2xl">
                            <p class="text-[9px] font-black text-gray-400 uppercase">Jornada</p>
                            <p class="text-xs font-bold text-gray-700">${d.jornada}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-2xl">
                            <p class="text-[9px] font-black text-gray-400 uppercase">Tiempo</p>
                            <p class="text-xs font-bold text-gray-700">${d.tiempo}</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-oferta').classList.replace('hidden', 'flex');
        }

        function closeModal() { document.getElementById('modal-oferta').classList.replace('flex', 'hidden'); }

        function switchTab(tab) {
            const btnP = document.getElementById('btn-practicas'), btnO = document.getElementById('btn-ofertas');
            const viewP = document.getElementById('view-practicas'), viewO = document.getElementById('view-ofertas');
            if (tab === 'practicas') {
                btnP.className = 'tab-active pb-2 px-2 text-sm uppercase tracking-tighter';
                btnO.className = 'tab-inactive pb-2 px-2 text-sm uppercase tracking-tighter';
                viewP.classList.remove('hidden'); viewO.classList.add('hidden');
            } else {
                btnO.className = 'tab-active pb-2 px-2 text-sm uppercase tracking-tighter';
                btnP.className = 'tab-inactive pb-2 px-2 text-sm uppercase tracking-tighter';
                viewO.classList.remove('hidden'); viewP.classList.add('hidden');
            }
        }
        init();
    </script>
</body>
</html>
