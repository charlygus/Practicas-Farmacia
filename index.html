<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento Pr√°cticas Farmacia üíä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* SEM√ÅFORO DE ESTADOS */
        .badge { @apply px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full shadow-sm border; }
        
        .status-pendiente { @apply bg-yellow-50 text-yellow-700 border-yellow-200; }
        .status-respondido { @apply bg-blue-50 text-blue-700 border-blue-200; }
        .status-exito { @apply bg-green-100 text-green-800 border-green-300 ring-2 ring-green-400 ring-opacity-50; }
        .status-rechazado { @apply bg-red-50 text-red-600 border-red-100 line-through opacity-75; }
        
        body { background-color: #f8fafc; }
        .row-rechazado { @apply bg-gray-50 opacity-60 grayscale; } /* Efecto visual para toda la fila */
    </style>
</head>
<body class="text-gray-800 font-sans antialiased">

    <div class="max-w-6xl mx-auto p-4 sm:p-8">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div>
                <h1 class="text-3xl font-extrabold text-teal-700 tracking-tight">üíä Mis Pr√°cticas</h1>
                <p class="text-gray-400 mt-1 text-sm">Panel de control de candidaturas</p>
            </div>
            
            <div class="mt-4 md:mt-0 flex gap-4 text-center">
                <div class="bg-yellow-50 p-2 rounded-lg border border-yellow-100">
                    <span id="count-pendiente" class="block text-xl font-bold text-yellow-700">0</span>
                    <span class="text-xs text-yellow-600 uppercase">Pendientes</span>
                </div>
                <div class="bg-green-50 p-2 rounded-lg border border-green-100">
                    <span id="count-exito" class="block text-xl font-bold text-green-700">0</span>
                    <span class="text-xs text-green-600 uppercase">Activos</span>
                </div>
                <div class="bg-red-50 p-2 rounded-lg border border-red-100">
                    <span id="count-rechazado" class="block text-xl font-bold text-red-700">0</span>
                    <span class="text-xs text-red-600 uppercase">Rechazados</span>
                </div>
            </div>
        </header>

        <div class="mb-6">
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </span>
                <input type="text" id="buscador" placeholder="üîç Buscar farmacia, pueblo, estado..." 
                       class="w-full pl-10 p-4 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-500 focus:outline-none bg-white">
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-100">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">Farmacia / Acciones</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">Ubicaci√≥n</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">Notas</th>
                        </tr>
                    </thead>
                    <tbody id="lista-farmacias" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </div>
        
        <footer class="mt-8 text-center text-xs text-gray-400 pb-8">
            <p>üí° Si actualizas el Sheet, espera 5 min y recarga esta p√°gina.</p>
        </footer>
    </div>

    <script>
        // TU ENLACE CONFIGURADO
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTHMTvkxxKH3An0VqizcHI2qYCcBfzLKyLjrhs7klbR_UyrTmy4f5M2aJurg9Vutb5VjEPLJxZEdX-r/pub?output=csv';

        function init() {
            // Truco anti-cach√©: A√±adimos un n√∫mero aleatorio al final de la URL
            const urlConTruco = sheetUrl + '&cache_buster=' + new Date().getTime();

            Papa.parse(urlConTruco, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    renderTable(results.data);
                    updateCounters(results.data);
                },
                error: function(err) {
                    console.error("Error:", err);
                    document.getElementById('lista-farmacias').innerHTML = `<tr><td colspan="4" class="p-6 text-center text-red-400">Error cargando datos.</td></tr>`;
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('lista-farmacias');
            tbody.innerHTML = '';

            // Ordenar: Exitos primero, Pendientes despues, Rechazados al final
            data.sort((a, b) => {
                const getScore = (estado) => {
                    const e = (estado || '').toLowerCase();
                    if (e.includes('entrevista') || e.includes('si') || e.includes('acept')) return 3; // Top
                    if (e.includes('respondido')) return 2;
                    if (e.includes('pendiente')) return 1;
                    if (e.includes('no') || e.includes('rechaz')) return 0; // Al fondo
                    return 1;
                };
                return getScore(b.ESTADO) - getScore(a.ESTADO);
            });

            data.forEach(row => {
                if (!row.FARMACIA) return;

                // L√≥gica del Sem√°foro
                const est = row.ESTADO ? row.ESTADO.toLowerCase() : 'pendiente';
                let statusClass = 'status-pendiente';
                let rowClass = '';
                let icon = '‚è≥';

                if (est.includes('pendiente')) {
                    statusClass = 'status-pendiente';
                    icon = '‚è≥';
                }
                else if (est.includes('respondido')) {
                    statusClass = 'status-respondido';
                    icon = 'üì©';
                }
                else if (est.includes('entrevista') || est.includes('si') || est.includes('acept') || est.includes('ok')) {
                    statusClass = 'status-exito';
                    icon = 'üöÄ';
                }
                else if (est.includes('no') || est.includes('rechaz') || est.includes('cerrado') || est.includes('denegado')) {
                    statusClass = 'status-rechazado';
                    rowClass = 'row-rechazado'; // Apaga toda la fila
                    icon = '‚ùå';
                }

                // Enlaces
                const mailSubject = encodeURIComponent("Candidatura Pr√°cticas - [Tu Nombre]");
                const mailBody = encodeURIComponent("Buenos d√≠as, \n\nQuer√≠a consultar el estado de mi candidatura...\n\nUn saludo.");
                const linkMail = `mailto:${row.EMAIL}?subject=${mailSubject}&body=${mailBody}`;
                const linkMaps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(row.FARMACIA + ' ' + row.LOCALIDAD)}`;

                const tr = document.createElement('tr');
                tr.className = `hover:bg-gray-50 transition-colors duration-150 ${rowClass}`;
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-800">${row.FARMACIA}</div>
                        <div class="flex gap-2 mt-2 opacity-100">
                            <a href="${linkMail}" class="text-xs bg-white border border-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-blue-50 hover:text-blue-600 transition flex items-center gap-1">
                                ‚úâÔ∏è Email
                            </a>
                            <a href="${linkMaps}" target="_blank" class="text-xs bg-white border border-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-green-50 hover:text-green-600 transition flex items-center gap-1">
                                üìç Mapa
                            </a>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">
                            ${row.LOCALIDAD}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="badge ${statusClass}">
                            ${icon} ${row.ESTADO || 'Pendiente'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 italic max-w-xs truncate">
                        ${row.NOTAS || '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateCounters(data) {
            let p = 0, e = 0, r = 0;
            data.forEach(row => {
                if(!row.FARMACIA) return;
                const st = (row.ESTADO || '').toLowerCase();
                if(st.includes('rechaz') || st.includes('no') || st.includes('cerrado')) r++;
                else if(st.includes('entrevista') || st.includes('si') || st.includes('acept')) e++;
                else p++;
            });
            
            animateValue("count-pendiente", p);
            animateValue("count-exito", e);
            animateValue("count-rechazado", r);
        }

        // Efecto visual contador
        function animateValue(id, end) {
            const obj = document.getElementById(id);
            obj.innerText = end;
        }

        // Buscador
        document.getElementById('buscador').addEventListener('keyup', function(e) {
            const term = e.target.value.toLowerCase();
            const filas = document.querySelectorAll('#lista-farmacias tr');
            filas.forEach(fila => {
                const texto = fila.innerText.toLowerCase();
                fila.style.display = texto.includes(term) ? '' : 'none';
            });
        });

        init();
    </script>
</body>
</html>
